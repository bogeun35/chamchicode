<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>참스코드 그림퀴즈</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#EFF6FF;--surface:#FFFFFF;--surface-alt:#F8FAFC;
  --border:#E2E8F0;--border-mid:#CBD5E1;
  --text:#0F172A;--text-sub:#475569;--text-dim:#94A3B8;
  --accent:#2563EB;--accent-light:#DBEAFE;
  --orange:#D97706;--green:#059669;--red:#DC2626;--purple:#7C3AED;
  --radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--text);color:white;padding:10px 24px;border-radius:20px;font-size:.9rem;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}

.screen{display:none;max-width:480px;margin:0 auto;padding:20px;}
.screen.active{display:block;}

.home-title{font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:900;text-align:center;margin:40px 0 8px;background:linear-gradient(135deg,var(--accent),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.home-sub{text-align:center;color:var(--text-dim);font-size:.9rem;margin-bottom:32px;font-weight:600;}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;}
.card-title{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:700;color:var(--text-sub);margin-bottom:12px;}
.input{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:1rem;font-family:inherit;font-weight:600;color:var(--text);background:var(--surface-alt);outline:none;}
.input:focus{border-color:var(--accent);}
.input-row{display:flex;gap:8px;margin-top:8px;}
.btn{padding:12px 20px;border:none;border-radius:10px;font-family:'Orbitron',sans-serif;font-size:.82rem;font-weight:700;cursor:pointer;transition:all .15s;}
.btn:hover{transform:translateY(-1px);}
.btn-primary{background:var(--accent);color:white;flex:1;}
.btn-orange{background:var(--orange);color:white;flex:1;}
.btn-green{background:var(--green);color:white;}
.btn-red{background:var(--red);color:white;}
.btn-sm{padding:6px 12px;font-size:.75rem;border-radius:6px;}
.btn-back{background:none;border:1px solid var(--border);color:var(--text-sub);font-family:'Rajdhani',sans-serif;font-size:.9rem;font-weight:600;padding:8px 16px;border-radius:8px;cursor:pointer;}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--text-sub);padding:6px 12px;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}

/* 게임 2단 */
.screen-game{max-width:960px;}
.game-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;}
.room-info{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.room-code{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:700;background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:8px;}
.role-tag{font-size:.75rem;font-weight:700;padding:4px 10px;border-radius:6px;}
.role-host{background:var(--orange);color:white;}
.role-guest{background:var(--accent-light);color:var(--accent);}
.share-btns{display:flex;gap:6px;}

/* 라운드/점수 바 */
.round-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-size:.82rem;font-weight:700;color:var(--text-sub);}
.round-info{display:flex;gap:12px;align-items:center;}
.round-badge{font-family:'Orbitron',sans-serif;font-size:.8rem;padding:4px 10px;border-radius:6px;background:var(--accent-light);color:var(--accent);}

/* 스코어보드 */
.scoreboard{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.score-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:.8rem;font-weight:600;transition:all .2s;}
.score-chip .s-nick{color:var(--text-sub);}
.score-chip .s-pts{font-family:'Orbitron',sans-serif;font-weight:900;color:var(--accent);font-size:.85rem;}
.score-chip.drawing{border-color:var(--accent);background:rgba(37,99,235,0.06);}
.score-chip.top{border-color:var(--orange);background:rgba(217,119,6,0.06);}
.score-chip.top .s-pts{color:var(--orange);}
.score-chip .s-rank{font-size:.7rem;color:var(--text-dim);margin-right:2px;}

/* 참여자 바 */
.members-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;align-items:center;}
.members-label{font-size:.8rem;font-weight:700;color:var(--text-dim);margin-right:4px;}
.member-chip{font-size:.78rem;font-weight:600;padding:4px 10px;border-radius:6px;background:var(--surface-alt);border:1px solid var(--border);color:var(--text-sub);display:flex;align-items:center;gap:4px;}
.member-chip .dot{width:6px;height:6px;border-radius:50%;background:var(--green);}
.member-chip.host{background:rgba(217,119,6,0.1);border-color:rgba(217,119,6,0.3);color:var(--orange);}

.game-layout{display:grid;grid-template-columns:1fr 300px;gap:16px;align-items:start;}

/* 모바일 탭 바 */
.mobile-tabs{display:none;margin-bottom:12px;}
.mobile-tabs-inner{display:flex;background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.mob-tab{flex:1;padding:10px;text-align:center;font-size:.85rem;font-weight:700;cursor:pointer;color:var(--text-dim);border:none;background:none;font-family:inherit;transition:all .15s;}
.mob-tab.active{background:var(--accent);color:white;}
.mob-tab .tab-badge{display:inline-block;min-width:18px;height:18px;line-height:18px;border-radius:9px;background:var(--red);color:white;font-size:.65rem;font-weight:900;margin-left:4px;text-align:center;vertical-align:middle;}

@media(max-width:768px){
  .screen-game{padding:8px 10px;position:fixed;top:0;left:0;right:0;bottom:0;overflow:hidden;max-width:100%;display:flex;flex-direction:column;z-index:100;background:var(--bg);}
  .screen-game.active{display:flex;}
  .game-header{margin-bottom:4px;flex-shrink:0;}
  .round-bar{margin-bottom:4px;padding:6px 12px;flex-shrink:0;}
  .scoreboard{margin-bottom:4px;flex-shrink:0;}
  .members-bar{margin-bottom:4px;padding:6px 10px;flex-shrink:0;display:none;}
  .host-controls{margin-bottom:4px;gap:4px;flex-shrink:0;}
  .mobile-tabs{display:block;margin-bottom:4px;flex-shrink:0;}
  .game-layout{grid-template-columns:1fr;gap:0;position:relative;flex:1;min-height:0;overflow:hidden;}
  .game-layout .canvas-panel{display:flex;flex-direction:column;height:100%;overflow:hidden;}
  .game-layout .canvas-panel .canvas-wrap{flex:1;min-height:0;aspect-ratio:auto;}
  .game-layout .chat-panel{display:none;}
  /* 채팅 탭 */
  .game-layout.show-chat .canvas-panel{display:flex;opacity:0.15;pointer-events:none;}
  .game-layout.show-chat .canvas-panel .toolbar{display:none !important;}
  .game-layout.show-chat .canvas-panel .word-display{display:none !important;}
  .game-layout.show-chat .canvas-panel .canvas-header{display:none;}
  .game-layout.show-chat .canvas-panel .mobile-quick-input{display:none !important;}
  .game-layout.show-chat .chat-panel{display:flex;position:absolute;top:0;left:0;right:0;bottom:0;height:auto;max-height:none;background:rgba(255,255,255,0.88);border:none;border-radius:var(--radius);z-index:10;}
  .ctrl-btn{padding:6px 10px;font-size:.78rem;}
  .canvas-header{padding:6px 10px;}
  .toolbar{padding:6px 8px;gap:3px;}
  .tool-btn{width:28px;height:28px;font-size:.75rem;}
  .color-btn{width:22px;height:22px;}
  .word-display{padding:6px;}
  .word-display .word-text{font-size:1.1rem;}
  .word-display .word-hint{font-size:1rem;}
  .chat-input-row{padding:8px;}
  .history-section{display:none !important;}
}

/* 캔버스 */
.canvas-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
.canvas-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);}
.canvas-status{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;color:var(--text-sub);}
.timer-badge{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:900;padding:4px 12px;border-radius:6px;background:var(--surface-alt);color:var(--text-sub);}
.timer-badge.warning{background:rgba(220,38,38,0.1);color:var(--red);animation:pulse .5s ease-in-out infinite;}
@keyframes pulse{50%{transform:scale(1.05);}}
.canvas-wrap{position:relative;background:white;aspect-ratio:4/3;}
.canvas-wrap canvas{width:100%;height:100%;display:block;cursor:crosshair;touch-action:none;}

.toolbar{display:flex;align-items:center;gap:6px;padding:10px 16px;border-top:1px solid var(--border);flex-wrap:wrap;}
.tool-btn{width:34px;height:34px;border:2px solid var(--border);border-radius:8px;background:var(--surface-alt);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all .15s;}
.tool-btn:hover{border-color:var(--accent);}
.tool-btn.active{border-color:var(--accent);background:var(--accent-light);}
.color-btn{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);cursor:pointer;transition:all .15s;}
.color-btn.active{border-color:var(--text);box-shadow:0 0 0 2px var(--accent-light);transform:scale(1.15);}
.size-range{width:60px;accent-color:var(--accent);}

.word-display{text-align:center;padding:16px;border-top:1px solid var(--border);}
.word-label{font-size:.75rem;color:var(--text-dim);font-weight:600;}
.word-text{font-family:'Orbitron',sans-serif;font-size:1.4rem;font-weight:900;color:var(--accent);margin-top:4px;letter-spacing:0.1em;}
.word-hint{font-family:'Orbitron',sans-serif;font-size:1.2rem;font-weight:700;color:var(--text-dim);margin-top:4px;letter-spacing:0.2em;}

.mobile-quick-input{display:none;padding:10px 12px;border-top:1px solid var(--border);gap:8px;}
@media(max-width:768px){
  .mobile-quick-input{display:flex;}
}

/* 채팅 */
.chat-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;height:520px;max-height:520px;}
.chat-title{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;color:var(--text-sub);padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0;}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:6px;min-height:0;}
.chat-msg{font-size:.85rem;padding:6px 10px;border-radius:8px;max-width:90%;word-break:break-word;}
.chat-msg.system{background:var(--surface-alt);color:var(--text-dim);font-weight:600;text-align:center;align-self:center;font-size:.78rem;}
.chat-msg.correct{background:rgba(5,150,105,0.1);color:var(--green);font-weight:700;text-align:center;align-self:center;}
.chat-msg.user{background:var(--surface-alt);}
.chat-msg .nick{font-weight:700;color:var(--accent);margin-right:6px;}
.chat-input-row{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);}
.chat-input{flex:1;padding:10px 12px;border:2px solid var(--border);border-radius:8px;font-size:.9rem;font-family:inherit;font-weight:600;outline:none;}
.chat-input:focus{border-color:var(--accent);}
.chat-send{padding:10px 16px;background:var(--accent);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-family:inherit;}

/* 방장 컨트롤 */
.host-controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
.ctrl-btn{padding:10px 16px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text-sub);font-size:.85rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;}
.ctrl-btn:hover{border-color:var(--accent);color:var(--accent);}
.ctrl-btn.start{background:var(--green);color:white;border-color:var(--green);}
.ctrl-btn.skip{background:var(--orange);color:white;border-color:var(--orange);}
.ctrl-btn.end{background:var(--red);color:white;border-color:var(--red);}
.ctrl-btn.words{background:var(--purple);color:white;border-color:var(--purple);}

.waiting{text-align:center;padding:60px 20px;}
.waiting-icon{font-size:3rem;margin-bottom:12px;}
.waiting-text{font-size:1.1rem;font-weight:700;color:var(--text-sub);}
.waiting-sub{font-size:.85rem;color:var(--text-dim);margin-top:4px;}
@media(max-width:768px){
  .waiting{padding:16px 12px;}
  .waiting-icon{font-size:1.8rem;margin-bottom:6px;}
  .waiting-text{font-size:.9rem;}
  .waiting-sub{font-size:.75rem;}
}

/* 오버레이 */
.correct-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(5,150,105,0.92);display:none;align-items:center;justify-content:center;z-index:5000;flex-direction:column;gap:12px;}
.correct-overlay.show{display:flex;}
.correct-overlay .big-text{font-family:'Orbitron',sans-serif;font-size:2rem;font-weight:900;color:white;}
.correct-overlay .sub-text{font-size:1.2rem;color:rgba(255,255,255,0.8);font-weight:600;}

.gameover-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,0.92);display:none;align-items:center;justify-content:center;z-index:5000;flex-direction:column;gap:16px;backdrop-filter:blur(4px);}
.gameover-overlay.show{display:flex;}
.gameover-title{font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:900;color:white;}
.gameover-list{display:flex;flex-direction:column;gap:8px;min-width:260px;}
.gameover-item{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:rgba(255,255,255,0.08);border-radius:10px;color:white;font-weight:600;font-size:.95rem;}
.gameover-item.first{background:rgba(217,119,6,0.3);border:1px solid rgba(217,119,6,0.5);}
.gameover-pts{font-family:'Orbitron',sans-serif;font-weight:900;font-size:1rem;}
.gameover-close{margin-top:8px;padding:10px 28px;background:white;color:var(--text);border:none;border-radius:10px;font-family:'Orbitron',sans-serif;font-weight:700;font-size:.85rem;cursor:pointer;}

/* 히스토리 */
.history-section{margin-top:16px;max-width:960px;}
.history-toggle{padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;font-size:.85rem;font-weight:700;color:var(--text-sub);transition:all .15s;}
.history-toggle:hover{border-color:var(--accent);color:var(--accent);}
.history-list{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.history-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;align-items:stretch;}
.history-card .h-thumb{width:140px;min-height:100px;flex-shrink:0;background:#f8f8f8;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--border);}
.history-card .h-thumb img{width:100%;height:100%;object-fit:contain;}
.history-card .h-info{flex:1;padding:12px 16px;display:flex;flex-direction:column;justify-content:center;gap:4px;}
.history-card .h-round{font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;color:var(--text-dim);}
.history-card .h-word{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:900;color:var(--accent);}
.history-card .h-detail{font-size:.8rem;color:var(--text-sub);font-weight:600;}
.history-card .h-solver{font-size:.8rem;color:var(--green);font-weight:700;}
.history-card .h-fail{font-size:.8rem;color:var(--red);font-weight:700;}
@media(max-width:768px){
  .history-card .h-thumb{width:100px;min-height:75px;}
  .history-card .h-info{padding:10px 12px;}
  .history-card .h-word{font-size:.85rem;}
}

/* 모달 공통 */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,0.5);display:none;align-items:center;justify-content:center;z-index:4000;backdrop-filter:blur(6px);}
.modal-overlay.show{display:flex;}
.modal-box{background:white;border-radius:16px;padding:28px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.15);max-height:80vh;overflow-y:auto;position:relative;}
.modal-title{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:700;margin-bottom:16px;text-align:center;}
.modal-row{display:flex;gap:8px;margin-top:12px;}
.modal-close{position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text-dim);line-height:1;}

.word-suggestions{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;}
.word-chip{padding:8px 14px;background:var(--surface-alt);border:1px solid var(--border);border-radius:8px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .15s;}
.word-chip:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}

/* 라운드 설정 */
.round-options{display:flex;gap:8px;justify-content:center;margin:16px 0;}
.round-opt{padding:12px 20px;border:2px solid var(--border);border-radius:10px;font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;background:var(--surface-alt);color:var(--text-sub);transition:all .15s;}
.round-opt:hover{border-color:var(--accent);}
.round-opt.active{border-color:var(--accent);background:var(--accent);color:white;}

/* 제시어 관리 */
.category-tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.cat-tab{padding:6px 14px;border:1px solid var(--border);border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;background:var(--surface-alt);color:var(--text-sub);transition:all .15s;}
.cat-tab.active{background:var(--accent);color:white;border-color:var(--accent);}
.cat-tab .cat-count{font-size:.7rem;opacity:.7;margin-left:4px;}
.word-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;min-height:40px;}
.word-tag{display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--surface-alt);border:1px solid var(--border);border-radius:6px;font-size:.8rem;font-weight:600;}
.word-tag .del-btn{background:none;border:none;color:var(--red);cursor:pointer;font-size:.75rem;font-weight:700;padding:0 2px;}
.add-row{display:flex;gap:6px;margin-top:10px;}
.add-row input{flex:1;padding:8px 10px;border:2px solid var(--border);border-radius:8px;font-size:.85rem;font-family:inherit;font-weight:600;outline:none;}
.add-row input:focus{border-color:var(--accent);}
.mgmt-divider{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.mgmt-footer{margin-top:16px;text-align:center;}
.word-stats{font-size:.8rem;color:var(--text-dim);margin-bottom:12px;text-align:center;}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- 홈 -->
<div class="screen active" id="screen-home">
  <div class="home-title">참스코드 그림퀴즈</div>
  <div class="home-sub">그려서 맞추는 실시간 파티게임</div>
  <div class="card">
    <div class="card-title">방 만들기</div>
    <input class="input" id="room-host" placeholder="닉네임" maxlength="10">
    <div class="input-row"><button class="btn btn-primary" onclick="createRoom()">방 만들기</button></div>
  </div>
  <div class="card">
    <div class="card-title">참여하기</div>
    <input class="input" id="join-code" placeholder="6자리 코드" maxlength="6" style="text-transform:uppercase;letter-spacing:0.15em;font-family:'Orbitron',sans-serif;">
    <input class="input" id="join-nick" placeholder="닉네임" maxlength="10" style="margin-top:8px;">
    <div class="input-row"><button class="btn btn-orange" onclick="joinRoom()">참여하기</button></div>
  </div>
</div>

<!-- 게임 -->
<div class="screen screen-game" id="screen-game">
  <div class="game-header">
    <div class="room-info">
      <button class="btn-back" onclick="leaveRoom()">&#8592; 나가기</button>
      <span class="room-code" id="g-code"></span>
      <span class="role-tag" id="g-role"></span>
    </div>
    <div class="share-btns">
      <button class="btn-ghost" onclick="copyCode()">코드 복사</button>
      <button class="btn-ghost" onclick="copyLink()">링크 복사</button>
    </div>
  </div>

  <!-- 라운드/점수 바 -->
  <div class="round-bar" id="round-bar" style="display:none;">
    <div class="round-info">
      <span id="round-label">라운드</span>
      <span class="round-badge" id="round-badge">0 / 0</span>
    </div>
  </div>

  <!-- 스코어보드 -->
  <div class="scoreboard" id="scoreboard"></div>

  <!-- 참여자 바 (게임 전) -->
  <div class="members-bar" id="g-members"></div>

  <div class="host-controls" id="host-controls" style="display:none;">
    <button class="ctrl-btn start" id="btn-start" onclick="onStartClick()">게임 시작</button>
    <button class="ctrl-btn skip" id="btn-skip" onclick="skipRound()" style="display:none;">스킵</button>
    <button class="ctrl-btn words" onclick="openWordManager()">제시어 관리</button>
    <button class="ctrl-btn end" id="btn-end" onclick="endGame()" style="display:none;">게임 종료</button>
  </div>

  <!-- 모바일 탭 -->
  <div class="mobile-tabs" id="mobile-tabs">
    <div class="mobile-tabs-inner">
      <button class="mob-tab active" id="tab-canvas" onclick="switchMobileTab('canvas')">그림판</button>
      <button class="mob-tab" id="tab-chat" onclick="switchMobileTab('chat')">채팅 <span class="tab-badge" id="chat-badge" style="display:none;">0</span></button>
    </div>
  </div>

  <div class="game-layout" id="game-layout">
    <div class="canvas-panel">
      <div class="canvas-header">
        <span class="canvas-status" id="canvas-status">대기 중</span>
        <span class="timer-badge" id="timer-badge">--</span>
      </div>
      <div class="canvas-wrap">
        <canvas id="draw-canvas" width="800" height="600"></canvas>
        <div class="waiting" id="waiting-screen">
          <div class="waiting-icon">&#9998;</div>
          <div class="waiting-text">방장이 게임을 시작하면<br>그림퀴즈가 시작됩니다</div>
          <div class="waiting-sub" id="waiting-sub"></div>
        </div>
      </div>
      <div class="toolbar" id="toolbar" style="display:none;">
        <button class="tool-btn active" data-tool="pen" onclick="setTool('pen',this)" title="펜">&#9998;</button>
        <button class="tool-btn" data-tool="line" onclick="setTool('line',this)" title="직선">&#9585;</button>
        <button class="tool-btn" data-tool="rect" onclick="setTool('rect',this)" title="사각형">&#9633;</button>
        <button class="tool-btn" data-tool="circle" onclick="setTool('circle',this)" title="원">&#9675;</button>
        <button class="tool-btn" data-tool="eraser" onclick="setTool('eraser',this)" title="지우개">&#9249;</button>
        <button class="tool-btn" data-tool="fill" onclick="setTool('fill',this)" title="채우기">&#9724;</button>
        <button class="tool-btn" onclick="undoLast()" title="되돌리기 (Ctrl+Z)">&#8630;</button>
        <button class="tool-btn" onclick="clearCanvas()" title="전체 지우기">&#128465;</button>
        <span style="width:1px;height:24px;background:var(--border);margin:0 4px;"></span>
        <input type="range" class="size-range" min="2" max="20" value="4" oninput="brushSize=this.value">
        <span style="width:1px;height:24px;background:var(--border);margin:0 4px;"></span>
        <div class="color-btn active" style="background:#0F172A" onclick="setColor('#0F172A',this)"></div>
        <div class="color-btn" style="background:#DC2626" onclick="setColor('#DC2626',this)"></div>
        <div class="color-btn" style="background:#2563EB" onclick="setColor('#2563EB',this)"></div>
        <div class="color-btn" style="background:#059669" onclick="setColor('#059669',this)"></div>
        <div class="color-btn" style="background:#D97706" onclick="setColor('#D97706',this)"></div>
        <div class="color-btn" style="background:#7C3AED" onclick="setColor('#7C3AED',this)"></div>
        <div class="color-btn" style="background:#FFFFFF;border-color:#CBD5E1;" onclick="setColor('#FFFFFF',this)"></div>
      </div>
      <div class="word-display" id="word-display" style="display:none;"></div>
      <!-- 모바일: 그림판에서 바로 정답 입력 -->
      <div class="mobile-quick-input" id="mobile-quick-input">
        <input class="chat-input" id="quick-input" placeholder="정답 입력..." maxlength="30" onkeydown="if(event.key==='Enter')sendQuickChat()">
        <button class="chat-send" onclick="sendQuickChat()">전송</button>
      </div>
    </div>
    <div class="chat-panel">
      <div class="chat-title">채팅</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input-row">
        <input class="chat-input" id="chat-input" placeholder="정답 입력..." maxlength="30" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="chat-send" onclick="sendChat()">전송</button>
      </div>
    </div>
  </div>

  <!-- 라운드 히스토리 -->
  <div class="history-section" id="history-section" style="display:none;">
    <div class="history-toggle" onclick="toggleHistory()">
      <span class="history-toggle-text" id="history-toggle-text">이전 라운드 보기</span>
    </div>
    <div class="history-list" id="history-list" style="display:none;"></div>
  </div>
</div>

<!-- 정답 오버레이 -->
<div class="correct-overlay" id="correct-overlay">
  <div class="big-text" id="correct-who"></div>
  <div class="sub-text" id="correct-word"></div>
</div>

<!-- 게임 종료 오버레이 -->
<div class="gameover-overlay" id="gameover-overlay">
  <div class="gameover-title">게임 종료</div>
  <div class="gameover-list" id="gameover-list"></div>
  <button class="gameover-close" onclick="closeGameover()">확인</button>
</div>

<!-- 라운드 설정 모달 -->
<div class="modal-overlay" id="round-modal">
  <div class="modal-box" style="max-width:380px;">
    <div class="modal-title">게임 설정</div>
    <div style="font-size:.82rem;font-weight:700;color:var(--text-sub);margin-bottom:8px;">총 라운드</div>
    <div class="round-options" id="round-options">
      <div class="round-opt" onclick="pickRound(5,this)">5</div>
      <div class="round-opt active" onclick="pickRound(10,this)">10</div>
      <div class="round-opt" onclick="pickRound(15,this)">15</div>
      <div class="round-opt" onclick="pickRound(20,this)">20</div>
    </div>
    <div style="font-size:.82rem;font-weight:700;color:var(--text-sub);margin-bottom:8px;">출제자 방식</div>
    <div class="round-options" id="drawer-mode-options">
      <div class="round-opt active" onclick="pickDrawerMode('winner',this)">정답자가 그리기</div>
      <div class="round-opt" onclick="pickDrawerMode('sequential',this)">순서대로 그리기</div>
    </div>
    <div class="modal-row">
      <button class="btn btn-primary" onclick="confirmStartGame()" style="flex:1;">게임 시작</button>
    </div>
  </div>
</div>

<!-- 제시어 선택 모달 -->
<div class="modal-overlay" id="word-modal">
  <div class="modal-box">
    <div class="modal-title" id="word-modal-title">제시어를 선택하세요</div>
    <div class="word-suggestions" id="word-suggestions"></div>
    <div style="text-align:center;color:var(--text-dim);font-size:.8rem;margin-top:12px;">또는 직접 입력</div>
    <input class="input" id="word-input" placeholder="직접 입력..." maxlength="20" style="margin-top:8px;" onkeydown="if(event.key==='Enter')submitWord()">
    <div class="modal-row">
      <button class="btn btn-primary" onclick="submitWord()" style="flex:1;">시작</button>
    </div>
  </div>
</div>

<!-- 제시어 관리 모달 -->
<div class="modal-overlay" id="word-mgmt-modal">
  <div class="modal-box" style="max-width:560px;">
    <button class="modal-close" onclick="closeWordManager()">&#10005;</button>
    <div class="modal-title">제시어 관리</div>
    <div class="word-stats" id="word-stats"></div>
    <div class="category-tabs" id="cat-tabs"></div>
    <div class="word-tags" id="word-tags"></div>
    <div class="add-row">
      <input id="add-word-input" placeholder="제시어 추가..." maxlength="20" onkeydown="if(event.key==='Enter')addWord()">
      <button class="btn btn-green btn-sm" onclick="addWord()">추가</button>
    </div>
    <div class="add-row mgmt-divider">
      <input id="add-cat-input" placeholder="새 카테고리..." maxlength="10" onkeydown="if(event.key==='Enter')addCategory()">
      <button class="btn btn-primary btn-sm" onclick="addCategory()">카테고리 추가</button>
      <button class="btn btn-red btn-sm" onclick="deleteCategory()">삭제</button>
    </div>
    <div class="mgmt-footer">
      <button class="btn btn-orange btn-sm" onclick="seedDefaultWords()">기본 제시어 초기화</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyD8_pSiOVOWmCitHl_nWcgSZobMFI5NgXM",authDomain:"rolling2-17a8f.firebaseapp.com",databaseURL:"https://rolling2-17a8f-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"rolling2-17a8f",storageBucket:"rolling2-17a8f.firebasestorage.app",messagingSenderId:"936512265515",appId:"1:936512265515:web:c9cb05f341267af81a796e"});
const db=firebase.database();

/* ===== 전역 ===== */
let currentRoom=null,isHost=false,myNick='',listeners=[],membersData={};
let gameState=null,scoresData={},wordBank={},allWords=[];
let drawCtx=null,drawing=false,lastX=0,lastY=0;
let currentTool='pen',brushColor='#0F172A',brushSize=4;
let strokeBuffer=[],strokeTimer=null,timerInterval=null;
let selectedCat='',totalRounds=10,drawerMode='winner';

const NICK_KEY='charms_draw_nick',ROUND_TIME=60;
const AUTO_NEXT_DELAY=3000; // 정답 후 자동 다음 라운드 딜레이

const DEFAULT_WORDS={
  '오버워치':['겐지','트레이서','위도우메이커','파라','리퍼','솔저76','메이','토르비욘','시메트라','바스티온','라인하르트','자리야','루시우','머시','정크랫','로드호그','디바','윈스턴','한조','아나','솜브라','오리사','둠피스트','모이라','에코','소전','용검','나노강화','자폭','대지분쇄','중력자탄','쌍용','핵폭탄'],
  '롤':['가렌','티모','야스오','아리','이즈리얼','럭스','리신','쓰레쉬','진','징크스','카타리나','아칼리','제드','르블랑','바이','케이틀린','드레이븐','블리츠크랭크','미스포춘','소라카','내셔남작','바론','드래곤','와드','미니언','포탑','넥서스','엘더드래곤','강타','점멸','캐니언','페이커'],
  '발로란트':['제트','레이즈','세이지','소바','오멘','바이퍼','피닉스','사이퍼','브림스톤','레이나','킬조이','스카이','요루','아스트라','네온','챔버','페이드','하버','데드록','클로브','테일윈드','블레이드스톰','부활','헌터의분노','바인드','어센트','헤이븐','스파이크'],
  '마인크래프트':['크리퍼','엔더맨','좀비','스켈레톤','다이아몬드','네더','엔더드래곤','위더','레드스톤','인챈트','엔더포탈','블레이즈','가스트','철골렘','마을주민','엔더진주','양털','TNT','흑요석','네더라이트','비콘','엘리트라','셜커상자','피글린','워든','체리나무'],
  '포켓몬':['피카츄','이상해씨','파이리','꼬부기','뮤츠','리자몽','잠만보','이브이','뮤','루기아','가이오가','레쿠쟈','디아루가','아르세우스','루카리오','가브리아스','리자드','나무지기','팽도리','뿔카노','게꿀닌자','지가르데','네크로즈마','울트라비스트','테라스탈'],
  '마리오':['마리오','루이지','피치','쿠파','요시','키노피오','와리오','로젤리나','굼바','엉금엉금','부끄부끄','뻐꾸기','별','슈퍼버섯','파이어플라워','무적별','카트','바나나껍질','파란등껍질','빨간등껍질','무지개로드','피치성','대쉬버섯'],
  '젤다':['링크','젤다','가논돌프','마스터소드','하이랄','시커슬레이트','파라세일','가디언','보코블린','라이넬','코로그','쉬커','야생의숨결','왕국의눈물','울트라핸드','퓨즈','조나이','트라이포스','요리','미파','달리아','시드','리발'],
  '배틀그라운드':['치킨','에란겔','미라마','프라이팬','AWM','카98','M416','에어드랍','부스트','자기장','레드존','낙하산','차량','길리슈트','레벨3헬멧','응급키트','수류탄','연막탄','윈체스터','크로스보우','교두보','태이고','데스턴'],
  '메이플스토리':['주황버섯','슬라임','예티','발록','핑크빈','검은마법사','카닝시티','헤네시스','리스항구','엘리니아','커닝타워','메소','메이플옹','넥슨','비숍','나이트로드','아크메이지','팬텀','루미너스','제로','아델','카인','라라'],
  '음식':['피자','치킨','햄버거','라면','초밥','떡볶이','김밥','짜장면','스파게티','타코','돈까스','삼겹살','불고기','비빔밥','냉면','만두','곱창','감자튀김','아이스크림','케이크','마카롱','붕어빵','호떡','떡갈비','파스타'],
  '게임용어':['GG','팀킬','캐리','딜러','탱커','힐러','버프','너프','쿨타임','마나','체력','경험치','레벨업','파밍','로밍','갱킹','라인전','한타','오브젝트','백도어','어그로','CC기','궁극기','패시브','리스폰','페이즈','랭크','티어','매치메이킹','메타']
};

/* ===== 유틸 ===== */
function sanitizeKey(s){return s.replace(/[.#$/\[\]]/g,'_');}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('screen-'+id).classList.add('active');}
function getSavedNick(){return localStorage.getItem(NICK_KEY)||'';}
function saveNick(n){localStorage.setItem(NICK_KEY,n);}
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<6;i++)r+=c[Math.floor(Math.random()*c.length)];return r;}
function makeHint(word){return word.split('').map(()=>'_').join(' ');}

// 한글 초성 추출
const CHOSUNG=['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
function getChosung(ch){
  const code=ch.charCodeAt(0)-0xAC00;
  if(code<0||code>11171) return '_'; // 한글 아니면 _
  return CHOSUNG[Math.floor(code/588)];
}
function makeChosungHint(word){
  return word.split('').map(ch=>{
    const code=ch.charCodeAt(0);
    if(code>=0xAC00&&code<=0xD7A3) return getChosung(ch);
    if(/[a-zA-Z0-9]/.test(ch)) return ch[0].toUpperCase();
    return '_';
  }).join(' ');
}
function makePartialHint(word){
  // 초성 + 일부 글자 공개 (약 1/3)
  const arr=word.split('');
  const revealCount=Math.max(1,Math.floor(arr.length/3));
  const indices=new Set();
  // 첫 글자는 항상 공개
  indices.add(0);
  while(indices.size<revealCount){
    indices.add(Math.floor(Math.random()*arr.length));
  }
  // 한번 계산하면 같은 라운드 내 고정하기 위해 캐시
  return arr.map((ch,i)=>{
    if(indices.has(i)) return ch;
    const code=ch.charCodeAt(0);
    if(code>=0xAC00&&code<=0xD7A3) return getChosung(ch);
    if(/[a-zA-Z0-9]/.test(ch)) return ch[0].toUpperCase();
    return '_';
  }).join(' ');
}

// 힌트 단계 캐시 (라운드마다 리셋)
let hintStage=0,cachedPartialHint='',hintRound=0;
let roundHistory=[]; // {round, drawer, word, solver, thumbUrl}

// 로컬 전용 시스템 메시지 (Firebase에 안 보냄, 중복 방지)
function addLocalSystemMsg(msg){
  const container=document.getElementById('chat-messages'),div=document.createElement('div');
  div.className='chat-msg system';div.textContent=msg;
  container.appendChild(div);container.scrollTop=container.scrollHeight;
}

function updateHintDisplay(){
  if(!gameState||gameState.status!=='drawing'||gameState.drawer===myNick) return;
  const word=gameState.word||'';
  const elapsed=Math.floor((Date.now()-gameState.startedAt)/1000);
  const third=Math.floor(ROUND_TIME/3);
  let newStage=0;
  if(elapsed>=third*2) newStage=2;
  else if(elapsed>=third) newStage=1;

  // 라운드 바뀌면 캐시 리셋
  if(hintRound!==gameState.round){
    hintRound=gameState.round;hintStage=0;cachedPartialHint='';
  }

  if(newStage!==hintStage){
    hintStage=newStage;
    if(hintStage===1) addLocalSystemMsg('초성 힌트가 공개되었습니다');
    if(hintStage===2){
      if(!cachedPartialHint) cachedPartialHint=makePartialHint(word);
      addLocalSystemMsg('추가 힌트가 공개되었습니다');
    }
  }

  const wordDisplay=document.getElementById('word-display');
  if(hintStage===0){
    wordDisplay.innerHTML=`<div class="word-label">힌트 (${word.length}글자)</div><div class="word-hint">${makeHint(word)}</div>`;
  }else if(hintStage===1){
    wordDisplay.innerHTML=`<div class="word-label">초성 힌트</div><div class="word-hint">${makeChosungHint(word)}</div>`;
  }else{
    wordDisplay.innerHTML=`<div class="word-label">추가 힌트</div><div class="word-hint">${cachedPartialHint}</div>`;
  }
}

(function(){const n=getSavedNick();if(n){document.getElementById('room-host').value=n;document.getElementById('join-nick').value=n;}})();

/* ===== 복사 기능 ===== */
function copyCode(){
  if(!currentRoom)return;
  navigator.clipboard.writeText(currentRoom.code).then(()=>toast('코드가 복사되었습니다'));
}
function copyLink(){
  if(!currentRoom)return;
  const url=window.location.href.split('?')[0]+'?room='+currentRoom.code;
  navigator.clipboard.writeText(url).then(()=>toast('링크가 복사되었습니다'));
}

/* ===== 제시어 DB ===== */
function loadWordBank(){
  db.ref('drawwords').on('value',snap=>{
    wordBank=snap.val()||{};allWords=[];
    Object.values(wordBank).forEach(cat=>{if(Array.isArray(cat))allWords.push(...cat);});
    if(!Object.keys(wordBank).length){db.ref('drawwords').set(DEFAULT_WORDS);return;}
  });
}
loadWordBank();
function seedDefaultWords(){if(!confirm('기본 제시어로 초기화합니다.'))return;db.ref('drawwords').set(DEFAULT_WORDS).then(()=>{toast('초기화 완료');renderWordManager();});}
function getRandomWords(n){const pool=[...allWords],result=[];while(result.length<n&&pool.length){const i=Math.floor(Math.random()*pool.length);result.push(pool.splice(i,1)[0]);}return result;}

/* ===== 방 생성/참여 ===== */
function createRoom(){
  const host=document.getElementById('room-host').value.trim();
  if(!host)return toast('닉네임을 입력해주세요');
  saveNick(host);const code=genCode();
  db.ref(`drawrooms/${code}`).set({host,createdAt:Date.now(),expiresAt:Date.now()+30*60*1000,game:null,scores:{}}).then(()=>{
    currentRoom={code,host};isHost=true;myNick=host;enterRoom();
  }).catch(()=>toast('방 생성 실패'));
}
function joinRoom(){
  const code=document.getElementById('join-code').value.trim().toUpperCase();
  const nick=document.getElementById('join-nick').value.trim();
  if(!code||code.length!==6)return toast('6자리 코드를 입력해주세요');
  if(!nick)return toast('닉네임을 입력해주세요');
  saveNick(nick);
  db.ref(`drawrooms/${code}`).once('value').then(snap=>{
    if(!snap.exists())return toast('존재하지 않는 방입니다');
    const d=snap.val();
    if(d.expiresAt&&Date.now()>d.expiresAt){['drawrooms','drawchat','drawcanvas','drawmembers'].forEach(p=>db.ref(`${p}/${code}`).remove());return toast('만료된 방입니다');}
    currentRoom={code,host:d.host};isHost=(d.host===nick);myNick=nick;enterRoom();
  }).catch(()=>toast('입장 실패'));
}

// URL 파라미터로 자동 입장
(function(){const p=new URLSearchParams(window.location.search);if(p.get('room'))document.getElementById('join-code').value=p.get('room');})();

function enterRoom(){
  document.getElementById('g-code').textContent=currentRoom.code;
  const role=document.getElementById('g-role');
  if(isHost){role.textContent='방장';role.className='role-tag role-host';document.getElementById('host-controls').style.display='flex';}
  else{role.textContent='참여자';role.className='role-tag role-guest';document.getElementById('host-controls').style.display='none';}
  showScreen('game');initCanvas();registerPresence();listenMembers();listenGame();listenScores();listenCanvas();listenChat();listenRoomExists();
  addSystemChat(`${myNick} 님이 입장했습니다`);
}

function leaveRoom(){
  if(isHost&&!confirm('방장이 나가면 방이 삭제됩니다.'))return;
  if(currentRoom){const code=currentRoom.code;
    if(isHost){['drawrooms','drawchat','drawcanvas','drawmembers'].forEach(p=>db.ref(`${p}/${code}`).remove());}
    else{db.ref(`drawmembers/${code}/${sanitizeKey(myNick)}`).remove();}
  }
  listeners.forEach(fn=>fn());listeners=[];if(timerInterval)clearInterval(timerInterval);
  currentRoom=null;gameState=null;scoresData={};membersData={};isHost=false;showScreen('home');
}

/* ===== Presence ===== */
function registerPresence(){
  const code=currentRoom.code,myKey=sanitizeKey(myNick),ref=db.ref(`drawmembers/${code}/${myKey}`);
  ref.set({nick:myNick,isHost,joinedAt:Date.now()});
  if(isHost){['drawrooms','drawchat','drawcanvas','drawmembers'].forEach(p=>db.ref(`${p}/${code}`).onDisconnect().remove());
    listeners.push(()=>{['drawrooms','drawchat','drawcanvas','drawmembers'].forEach(p=>db.ref(`${p}/${code}`).onDisconnect().cancel());});
  }else{ref.onDisconnect().remove();listeners.push(()=>{ref.onDisconnect().cancel();ref.remove();});}
}

function listenMembers(){
  const ref=db.ref(`drawmembers/${currentRoom.code}`);
  let initialized=false;
  const cbVal=ref.on('value',snap=>{
    membersData=snap.val()||{};renderMembers();renderScoreboard();
    if(!initialized) initialized=true;
  });
  const cbAdd=ref.on('child_added',snap=>{
    if(!initialized)return; // 초기 로드 시 알림 안 함
    const d=snap.val();
    if(d&&d.nick&&d.nick!==myNick) addSystemChat(`${d.nick} 님이 입장했습니다`);
  });
  const cbRemove=ref.on('child_removed',snap=>{
    const d=snap.val();
    if(d&&d.nick) addSystemChat(`${d.nick} 님이 퇴장했습니다`);
  });
  listeners.push(()=>{ref.off('value',cbVal);ref.off('child_added',cbAdd);ref.off('child_removed',cbRemove);});
}
function renderMembers(){
  const bar=document.getElementById('g-members');
  const entries=Object.values(membersData);
  entries.sort((a,b)=>(b.isHost?1:0)-(a.isHost?1:0));
  bar.innerHTML=`<span class="members-label">참여자 ${entries.length}</span>`+
    entries.map(m=>`<span class="member-chip ${m.isHost?'host':''}"><span class="dot"></span>${esc(m.nick)}</span>`).join('');
}
function listenRoomExists(){
  if(isHost)return;const ref=db.ref(`drawrooms/${currentRoom.code}`);
  const cb=ref.on('value',snap=>{if(!snap.exists()){toast('방이 종료되었습니다');listeners.forEach(fn=>fn());listeners=[];if(timerInterval)clearInterval(timerInterval);currentRoom=null;gameState=null;scoresData={};membersData={};isHost=false;showScreen('home');}});
  listeners.push(()=>ref.off('value',cb));
}

/* ===== 점수 ===== */
function listenScores(){
  const ref=db.ref(`drawrooms/${currentRoom.code}/scores`);
  const cb=ref.on('value',snap=>{scoresData=snap.val()||{};renderScoreboard();});
  listeners.push(()=>ref.off('value',cb));
}

function renderScoreboard(){
  const board=document.getElementById('scoreboard');
  const members=Object.values(membersData).map(m=>m.nick);
  if(!members.length){board.innerHTML='';return;}
  // 점수 정렬
  const list=members.map(nick=>({nick,pts:scoresData[sanitizeKey(nick)]||0}));
  list.sort((a,b)=>b.pts-a.pts);
  const drawer=gameState?.drawer||'';
  board.innerHTML=list.map((item,i)=>{
    let cls='';
    if(item.nick===drawer)cls='drawing';
    if(i===0&&item.pts>0)cls+=' top';
    const rank=item.pts>0?`<span class="s-rank">#${i+1}</span>`:'';
    return `<span class="score-chip ${cls}">${rank}<span class="s-nick">${esc(item.nick)}</span><span class="s-pts">${item.pts}</span></span>`;
  }).join('');
}

function addScore(nick,pts){
  const key=sanitizeKey(nick);
  const current=scoresData[key]||0;
  db.ref(`drawrooms/${currentRoom.code}/scores/${key}`).set(current+pts);
}

/* ===== 게임 상태 ===== */
function listenGame(){
  const ref=db.ref(`drawrooms/${currentRoom.code}/game`);
  const cb=ref.on('value',snap=>{gameState=snap.val();renderGameState();renderScoreboard();});
  listeners.push(()=>ref.off('value',cb));
}

function renderGameState(){
  const status=gameState?.status;
  const isDrawer=gameState?.drawer===myNick;
  const waiting=document.getElementById('waiting-screen');
  const toolbar=document.getElementById('toolbar');
  const wordDisplay=document.getElementById('word-display');
  const canvasStatus=document.getElementById('canvas-status');
  const timerBadge=document.getElementById('timer-badge');
  const roundBar=document.getElementById('round-bar');

  // 라운드 바
  if(gameState?.totalRounds){
    roundBar.style.display='flex';
    document.getElementById('round-badge').textContent=`${gameState.round||0} / ${gameState.totalRounds}`;
  }else{roundBar.style.display='none';}

  // 방장 버튼 상태
  if(isHost){
    const playing=status==='drawing'||status==='reveal'||status==='picking';
    document.getElementById('btn-start').style.display=(!status||status==='idle')?'':'none';
    document.getElementById('btn-start').textContent='게임 시작';
    document.getElementById('btn-skip').style.display=status==='drawing'?'':'none';
    document.getElementById('btn-end').style.display=playing?'':'none';
  }

  const canvasWrap=document.querySelector('.canvas-wrap');

  if(!status||status==='idle'){
    waiting.style.display='flex';toolbar.style.display='none';wordDisplay.style.display='none';
    if(canvasWrap)canvasWrap.style.display='none';
    canvasStatus.textContent='대기 중';timerBadge.textContent='--';
    document.getElementById('waiting-sub').textContent=isHost?'"게임 시작" 버튼을 눌러주세요':'방장이 시작하면 게임이 시작됩니다';
    if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
    clearCanvasLocal();
    document.getElementById('chat-input').disabled=false;
    document.getElementById('chat-input').placeholder='채팅...';
    document.getElementById('word-modal').classList.remove('show');
    document.getElementById('correct-overlay').classList.remove('show');
    if(gameState?.gameover){showGameoverOverlay();}
    return;
  }

  if(status==='picking'){
    waiting.style.display='flex';toolbar.style.display='none';wordDisplay.style.display='none';
    if(canvasWrap)canvasWrap.style.display='none';
    canvasStatus.textContent=`${gameState.drawer} 님이 제시어 선택 중`;
    timerBadge.textContent='--';
    document.getElementById('chat-input').disabled=false;
    document.getElementById('chat-input').placeholder='채팅...';
    if(gameState.drawer===myNick && !document.getElementById('word-modal').classList.contains('show')){
      showWordModal();
    }
    document.getElementById('waiting-sub').textContent=gameState.drawer===myNick?'제시어를 선택해주세요':`${gameState.drawer} 님이 제시어를 고르는 중...`;
    renderScoreboard();
    return;
  }

  // drawing/reveal: 캔버스 보이기
  if(canvasWrap)canvasWrap.style.display='';
  waiting.style.display='none';

  if(status==='drawing'){
    const qi=document.getElementById('quick-input');
    if(isDrawer){
      toolbar.style.display='flex';wordDisplay.style.display='block';
      wordDisplay.innerHTML=`<div class="word-label">제시어</div><div class="word-text">${esc(gameState.word)}</div>`;
      document.getElementById('chat-input').disabled=true;
      document.getElementById('chat-input').placeholder='출제자는 채팅 불가';
      qi.disabled=true;qi.placeholder='출제자는 입력 불가';
    }else{
      toolbar.style.display='none';wordDisplay.style.display='block';
      wordDisplay.innerHTML=`<div class="word-label">힌트 (${gameState.word?.length||'?'}글자)</div><div class="word-hint">${makeHint(gameState.word||'')}</div>`;
      document.getElementById('chat-input').disabled=false;
      document.getElementById('chat-input').placeholder='정답 입력...';
      qi.disabled=false;qi.placeholder='정답 입력...';
    }
    canvasStatus.textContent=`${gameState.drawer} 님이 그리는 중`;
    startTimer();renderScoreboard();
  }

  if(status==='reveal'){
    toolbar.style.display='none';wordDisplay.style.display='block';
    wordDisplay.innerHTML=`<div class="word-label">정답</div><div class="word-text">${esc(gameState.word||'')}</div>`;
    canvasStatus.textContent='라운드 종료';
    document.getElementById('chat-input').disabled=false;
    document.getElementById('chat-input').placeholder='채팅...';
    document.getElementById('quick-input').disabled=false;
    document.getElementById('quick-input').placeholder='채팅...';
    if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
    timerBadge.textContent='--';timerBadge.classList.remove('warning');

    // 히스토리 스냅샷 저장 (중복 방지)
    const curRound=gameState.round||0;
    if(curRound>0 && !roundHistory.find(h=>h.round===curRound)){
      try{
        const thumbUrl=document.getElementById('draw-canvas').toDataURL('image/png',0.4);
        roundHistory.push({
          round:curRound,
          drawer:gameState.drawer||'',
          word:gameState.word||'',
          solver:gameState.nextDrawer||null,
          thumbUrl
        });
        renderHistory();
      }catch(ex){}
    }

    // 방장: 자동 다음 라운드 or 게임 종료
    if(isHost){
      if(gameState.round>=gameState.totalRounds){
        setTimeout(()=>finishGame(),AUTO_NEXT_DELAY);
      }else{
        setTimeout(()=>{if(gameState?.status==='reveal')autoNextRound();},AUTO_NEXT_DELAY);
      }
    }
  }
}

function startTimer(){
  if(timerInterval)clearInterval(timerInterval);
  const badge=document.getElementById('timer-badge');
  timerInterval=setInterval(()=>{
    if(!gameState||gameState.status!=='drawing')return;
    const elapsed=Math.floor((Date.now()-gameState.startedAt)/1000);
    const remain=Math.max(ROUND_TIME-elapsed,0);
    badge.textContent=remain+'s';
    badge.classList.toggle('warning',remain<=10);
    updateHintDisplay();
    if(remain<=0&&isHost){clearInterval(timerInterval);timerInterval=null;endRound(null);}
  },500);
}

/* ===== 게임 시작 / 라운드 ===== */
function onStartClick(){
  if(!isHost)return;
  const members=Object.values(membersData).map(m=>m.nick);
  if(members.length<2)return toast('2명 이상 필요합니다');
  if(!allWords.length)return toast('제시어가 없습니다');
  // 라운드 설정 모달
  document.getElementById('round-modal').classList.add('show');
}

function pickRound(n,el){
  totalRounds=n;
  document.querySelectorAll('#round-options .round-opt').forEach(o=>o.classList.remove('active'));
  el.classList.add('active');
}

function pickDrawerMode(mode,el){
  drawerMode=mode;
  document.querySelectorAll('#drawer-mode-options .round-opt').forEach(o=>o.classList.remove('active'));
  el.classList.add('active');
}

function confirmStartGame(){
  document.getElementById('round-modal').classList.remove('show');
  roundHistory=[];renderHistory();
  const scores={};
  Object.values(membersData).forEach(m=>{scores[sanitizeKey(m.nick)]=0;});
  db.ref(`drawrooms/${currentRoom.code}/scores`).set(scores);
  const modeLabel=drawerMode==='winner'?'정답자가 그리기':'순서대로 그리기';
  db.ref(`drawrooms/${currentRoom.code}/game`).set({status:'idle',round:0,totalRounds,nextDrawer:null,drawerMode,drawerIndex:0});
  addSystemChat(`게임 시작! ${totalRounds}라운드 / ${modeLabel}`);
  setTimeout(()=>startNextRound(null),500);
}

function startNextRound(nextDrawer){
  if(!isHost)return;
  const members=Object.values(membersData).map(m=>m.nick);
  const mode=gameState?.drawerMode||drawerMode;
  let drawer;
  let nextIndex=gameState?.drawerIndex||0;

  if(mode==='sequential'){
    // 순서대로: drawerIndex 기반
    drawer=members[nextIndex % members.length];
    nextIndex=(nextIndex+1)%members.length;
  }else{
    // winner 모드: 정답자 우선, 없으면 랜덤
    if(nextDrawer&&members.includes(nextDrawer)){
      drawer=nextDrawer;
    }else{
      const prev=gameState?.drawer;
      let candidates=members.filter(m=>m!==prev);
      if(!candidates.length)candidates=members;
      drawer=candidates[Math.floor(Math.random()*candidates.length)];
    }
  }

  const round=(gameState?.round||0)+1;
  db.ref(`drawcanvas/${currentRoom.code}`).remove();
  db.ref(`drawrooms/${currentRoom.code}/game`).set({
    status:'picking',drawer,word:null,round,
    totalRounds:gameState?.totalRounds||totalRounds,
    startedAt:null,solved:false,nextDrawer:null,
    drawerMode:mode,drawerIndex:nextIndex,
    wordChoices:getRandomWords(8)
  });
  addSystemChat(`[${round}/${gameState?.totalRounds||totalRounds}] ${drawer} 님이 제시어를 고르는 중...`);
}

function autoNextRound(){
  if(!gameState||gameState.status!=='reveal')return;
  startNextRound(gameState.nextDrawer||null);
}

function showWordModal(){
  document.getElementById('word-modal').classList.add('show');
  document.getElementById('word-input').value='';
  document.getElementById('word-modal-title').textContent='제시어를 선택하세요';
  const suggestions=gameState?.wordChoices||getRandomWords(8);
  document.getElementById('word-suggestions').innerHTML=suggestions.map(w=>
    `<span class="word-chip" onclick="document.getElementById('word-input').value='${esc(w)}';submitWord()">${esc(w)}</span>`
  ).join('');
}

function submitWord(){
  const word=document.getElementById('word-input').value.trim();
  if(!word)return toast('제시어를 선택 또는 입력해주세요');
  document.getElementById('word-modal').classList.remove('show');
  const round=gameState?.round||1;
  const total=gameState?.totalRounds||totalRounds;
  // 출제자 본인이 직접 drawing 시작
  db.ref(`drawrooms/${currentRoom.code}/game`).update({
    status:'drawing',word,startedAt:Date.now(),solved:false,wordChoices:null
  });
  addSystemChat(`[${round}/${total}] ${myNick} 님이 그립니다! (${word.length}글자)`);
}

function skipRound(){if(!isHost)return;endRound(null);}

function endRound(solver){
  if(!gameState||gameState.status!=='drawing')return;
  db.ref(`drawrooms/${currentRoom.code}/game`).update({status:'reveal',nextDrawer:solver||null});
  if(!solver)addSystemChat(`정답: ${gameState.word}`);
}

function endGame(){
  if(!isHost)return;
  finishGame();
}

function finishGame(){
  showGameoverOverlay();
  db.ref(`drawrooms/${currentRoom.code}/game`).set({status:'idle',round:0,totalRounds:0,nextDrawer:null,gameover:true});
  db.ref(`drawcanvas/${currentRoom.code}`).remove();
  addSystemChat('게임이 종료되었습니다!');
  // gameover 플래그 5초 후 제거
  setTimeout(()=>{
    if(currentRoom) db.ref(`drawrooms/${currentRoom.code}/game/gameover`).remove();
  },5000);
}

/* ===== 라운드 히스토리 ===== */
function renderHistory(){
  const section=document.getElementById('history-section');
  const list=document.getElementById('history-list');
  if(!roundHistory.length){section.style.display='none';list.innerHTML='';return;}
  section.style.display='block';
  document.getElementById('history-toggle-text').textContent=`이전 라운드 (${roundHistory.length})`;
  list.innerHTML=roundHistory.slice().reverse().map(h=>{
    const solverHtml=h.solver
      ?`<div class="h-solver">${esc(h.solver)} 정답 (+1)</div>`
      :`<div class="h-fail">시간 초과</div>`;
    const drawerPts=h.solver?` (+1)`:'';
    return `<div class="history-card">
      <div class="h-thumb"><img src="${h.thumbUrl}" alt="R${h.round}"></div>
      <div class="h-info">
        <div class="h-round">ROUND ${h.round}</div>
        <div class="h-word">${esc(h.word)}</div>
        <div class="h-detail">${esc(h.drawer)} 출제${drawerPts}</div>
        ${solverHtml}
      </div>
    </div>`;
  }).join('');
}

function toggleHistory(){
  const list=document.getElementById('history-list');
  const visible=list.style.display!=='none';
  list.style.display=visible?'none':'flex';
}

function showGameoverOverlay(){
  const members=Object.values(membersData).map(m=>m.nick);
  const list=members.map(nick=>({nick,pts:scoresData[sanitizeKey(nick)]||0}));
  list.sort((a,b)=>b.pts-a.pts);
  const container=document.getElementById('gameover-list');
  container.innerHTML=list.map((item,i)=>
    `<div class="gameover-item ${i===0&&item.pts>0?'first':''}"><span>${i===0&&item.pts>0?'&#127942; ':''}${esc(item.nick)}</span><span class="gameover-pts">${item.pts}점</span></div>`
  ).join('');
  document.getElementById('gameover-overlay').classList.add('show');
}
function closeGameover(){document.getElementById('gameover-overlay').classList.remove('show');}

/* ===== 제시어 관리 ===== */
function openWordManager(){document.getElementById('word-mgmt-modal').classList.add('show');const cats=Object.keys(wordBank);if(cats.length&&!cats.includes(selectedCat))selectedCat=cats[0];renderWordManager();}
function closeWordManager(){document.getElementById('word-mgmt-modal').classList.remove('show');}
function renderWordManager(){
  const cats=Object.keys(wordBank);
  document.getElementById('word-stats').textContent=`${cats.length}개 카테고리 / 총 ${allWords.length}개 제시어`;
  document.getElementById('cat-tabs').innerHTML=cats.map(c=>
    `<span class="cat-tab ${c===selectedCat?'active':''}" onclick="selectedCat='${esc(c)}';renderWordManager()">${esc(c)}<span class="cat-count">${(wordBank[c]||[]).length}</span></span>`
  ).join('');
  const words=wordBank[selectedCat]||[];
  document.getElementById('word-tags').innerHTML=words.map((w,i)=>
    `<span class="word-tag">${esc(w)}<button class="del-btn" onclick="removeWord(${i})">&#10005;</button></span>`
  ).join('')||`<span style="color:var(--text-dim);font-size:.85rem;">${selectedCat?'비어있음':'카테고리를 선택하세요'}</span>`;
}
function addWord(){const input=document.getElementById('add-word-input'),word=input.value.trim();if(!word)return;if(!selectedCat)return toast('카테고리를 먼저 선택');const words=wordBank[selectedCat]||[];if(words.includes(word))return toast('이미 있는 제시어');words.push(word);db.ref(`drawwords/${selectedCat}`).set(words);input.value='';input.focus();}
function removeWord(idx){if(!selectedCat)return;const words=wordBank[selectedCat]||[];words.splice(idx,1);if(words.length)db.ref(`drawwords/${selectedCat}`).set(words);else{db.ref(`drawwords/${selectedCat}`).remove();delete wordBank[selectedCat];const cats=Object.keys(wordBank);selectedCat=cats[0]||'';}}
function addCategory(){const input=document.getElementById('add-cat-input'),cat=input.value.trim();if(!cat)return;if(wordBank[cat])return toast('이미 있는 카테고리');db.ref(`drawwords/${cat}`).set([]);selectedCat=cat;input.value='';}
function deleteCategory(){if(!selectedCat)return;if(!confirm(`"${selectedCat}" 카테고리를 삭제합니다.`))return;db.ref(`drawwords/${selectedCat}`).remove();delete wordBank[selectedCat];const cats=Object.keys(wordBank);selectedCat=cats[0]||'';renderWordManager();}

/* ===== 캔버스 ===== */
let shapeStartX=0,shapeStartY=0,canvasSnapshot=null,shiftHeld=false;
const SHAPE_TOOLS=['line','rect','circle'];
let undoKeys=[];       // 내가 push한 Firebase key 목록
let canvasData={};     // key→데이터 전체 캐시 (리드로우용)
let canvasKeyOrder=[]; // key 순서 보존

document.addEventListener('keydown',e=>{
  if(e.key==='Shift')shiftHeld=true;
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undoLast();}
});
document.addEventListener('keyup',e=>{if(e.key==='Shift')shiftHeld=false;});

function initCanvas(){
  const canvas=document.getElementById('draw-canvas');
  drawCtx=canvas.getContext('2d');
  drawCtx.lineCap='round';drawCtx.lineJoin='round';
  clearCanvasLocal();
  canvas.addEventListener('pointerdown',onPointerDown);
  canvas.addEventListener('pointermove',onPointerMove);
  canvas.addEventListener('pointerup',onPointerUp);
  canvas.addEventListener('pointerleave',onPointerLeave);
  // 캔버스 밖에서 마우스 놓아도 도형 확정
  document.addEventListener('pointerup',e=>{
    if(drawing&&SHAPE_TOOLS.includes(currentTool)){onPointerUp(e);}
  });
}
function getCanvasPos(e){
  const c=document.getElementById('draw-canvas'),r=c.getBoundingClientRect();
  return{x:(e.clientX-r.left)*(c.width/r.width),y:(e.clientY-r.top)*(c.height/r.height)};
}

function onPointerDown(e){
  if(!gameState||gameState.status!=='drawing'||gameState.drawer!==myNick)return;
  const p=getCanvasPos(e);
  if(currentTool==='fill'){
    const x=Math.round(p.x),y=Math.round(p.y);
    floodFill(x,y,brushColor);
    pushToCanvas([{fill:true,x,y,c:brushColor}]);
    return;
  }
  drawing=true;
  if(SHAPE_TOOLS.includes(currentTool)){
    shapeStartX=p.x;shapeStartY=p.y;
    canvasSnapshot=drawCtx.getImageData(0,0,800,600);
  }else{
    lastX=p.x;lastY=p.y;strokeBuffer=[];
  }
}

function onPointerMove(e){
  if(!drawing)return;
  const p=getCanvasPos(e);
  if(SHAPE_TOOLS.includes(currentTool)){
    drawCtx.putImageData(canvasSnapshot,0,0);
    const s=calcShape(shapeStartX,shapeStartY,p.x,p.y,shiftHeld);
    renderShape(s,currentTool,brushColor,Number(brushSize));
    return;
  }
  const x=p.x,y=p.y;
  const color=currentTool==='eraser'?'#FFFFFF':brushColor;
  const size=currentTool==='eraser'?brushSize*4:brushSize;
  drawLine(lastX,lastY,x,y,color,size);
  strokeBuffer.push({x1:lastX,y1:lastY,x2:x,y2:y,c:color,s:Number(size)});
  lastX=x;lastY=y;
  if(!strokeTimer){strokeTimer=setTimeout(()=>{flushStrokes();strokeTimer=null;},80);}
}

function onPointerUp(e){
  if(!drawing)return;
  drawing=false;
  if(SHAPE_TOOLS.includes(currentTool)&&canvasSnapshot){
    // 마우스 현재 위치로 도형 확정
    let endX=shapeStartX,endY=shapeStartY;
    try{const p=getCanvasPos(e);endX=p.x;endY=p.y;}catch(ex){}
    drawCtx.putImageData(canvasSnapshot,0,0);
    const s=calcShape(shapeStartX,shapeStartY,endX,endY,shiftHeld);
    renderShape(s,currentTool,brushColor,Number(brushSize));
    pushToCanvas([{
      shape:currentTool,x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2,c:brushColor,s:Number(brushSize)
    }]);
    canvasSnapshot=null;
    return;
  }
  flushStrokes();
}
function onPointerLeave(e){
  // 도형 도구 드래그 중이면 캔버스 밖으로 나가도 유지 (pointerup에서 처리)
  if(SHAPE_TOOLS.includes(currentTool))return;
  if(!drawing)return;
  drawing=false;flushStrokes();
}

function calcShape(x1,y1,x2,y2,shift){
  let dx=x2-x1,dy=y2-y1;
  if(shift){
    if(currentTool==='line'){
      const angle=Math.atan2(dy,dx);
      const snap=Math.round(angle/(Math.PI/4))*(Math.PI/4);
      const len=Math.sqrt(dx*dx+dy*dy);
      dx=Math.cos(snap)*len;dy=Math.sin(snap)*len;
    }else{
      const sz=Math.max(Math.abs(dx),Math.abs(dy));
      dx=sz*Math.sign(dx||1);dy=sz*Math.sign(dy||1);
    }
  }
  return{x1,y1,x2:x1+dx,y2:y1+dy};
}

function renderShape(s,type,color,size){
  drawCtx.strokeStyle=color;drawCtx.lineWidth=size;
  drawCtx.lineCap='round';drawCtx.lineJoin='round';
  drawCtx.beginPath();
  if(type==='line'){
    drawCtx.moveTo(s.x1,s.y1);drawCtx.lineTo(s.x2,s.y2);
  }else if(type==='rect'){
    drawCtx.rect(s.x1,s.y1,s.x2-s.x1,s.y2-s.y1);
  }else if(type==='circle'){
    const cx=(s.x1+s.x2)/2,cy=(s.y1+s.y2)/2;
    const rx=Math.abs(s.x2-s.x1)/2,ry=Math.abs(s.y2-s.y1)/2;
    if(rx>0&&ry>0) drawCtx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
  }
  drawCtx.stroke();
}

function flushStrokes(){if(!strokeBuffer.length||!currentRoom)return;pushToCanvas(strokeBuffer);strokeBuffer=[];}
function drawLine(x1,y1,x2,y2,color,size){drawCtx.strokeStyle=color;drawCtx.lineWidth=size;drawCtx.beginPath();drawCtx.moveTo(x1,y1);drawCtx.lineTo(x2,y2);drawCtx.stroke();}
function clearCanvas(){
  if(!gameState||gameState.drawer!==myNick)return;
  clearCanvasLocal();undoKeys=[];
  db.ref(`drawcanvas/${currentRoom.code}`).remove();
  db.ref(`drawcanvas/${currentRoom.code}`).push().set([{clear:true}]);
}
function clearCanvasLocal(){if(!drawCtx)return;const c=document.getElementById('draw-canvas');drawCtx.fillStyle='#FFFFFF';drawCtx.fillRect(0,0,c.width,c.height);}

function setTool(tool,el){
  currentTool=tool;
  document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('draw-canvas').style.cursor=tool==='fill'?'cell':'crosshair';
}
function setColor(c,el){
  brushColor=c;
  // 도형 도구 사용 중이면 유지, 아니면 pen으로
  if(!SHAPE_TOOLS.includes(currentTool)&&currentTool!=='fill') currentTool='pen';
  document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.classList.toggle('active',b.dataset.tool===currentTool));
  document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

// Flood Fill
function hexToRgb(hex){return[parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)];}
function floodFill(startX,startY,fillHex){
  const canvas=document.getElementById('draw-canvas');
  const w=canvas.width,h=canvas.height;
  if(startX<0||startX>=w||startY<0||startY>=h)return;
  const imageData=drawCtx.getImageData(0,0,w,h),data=imageData.data;
  const[fr,fg,fb]=hexToRgb(fillHex);
  const idx=(startY*w+startX)*4;
  const tr=data[idx],tg=data[idx+1],tb=data[idx+2];
  if(tr===fr&&tg===fg&&tb===fb)return;
  const tol=30;
  function match(i){return Math.abs(data[i]-tr)<=tol&&Math.abs(data[i+1]-tg)<=tol&&Math.abs(data[i+2]-tb)<=tol;}
  const stack=[[startX,startY]],visited=new Uint8Array(w*h);
  while(stack.length){
    const[x,y]=stack.pop(),pi=y*w+x;
    if(x<0||x>=w||y<0||y>=h||visited[pi])continue;
    const i=pi*4;if(!match(i))continue;
    visited[pi]=1;data[i]=fr;data[i+1]=fg;data[i+2]=fb;data[i+3]=255;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
  drawCtx.putImageData(imageData,0,0);
}

// Firebase push 래퍼 (undo key 저장)
function pushToCanvas(data){
  if(!currentRoom)return;
  const ref=db.ref(`drawcanvas/${currentRoom.code}`).push();
  ref.set(data);
  undoKeys.push(ref.key);
}

// Undo
function undoLast(){
  if(!gameState||gameState.drawer!==myNick||!undoKeys.length)return;
  const key=undoKeys.pop();
  db.ref(`drawcanvas/${currentRoom.code}/${key}`).remove();
  // child_removed가 리드로우를 트리거함
}

// 전체 리드로우
function redrawAll(){
  clearCanvasLocal();
  canvasKeyOrder.forEach(key=>{
    const arr=canvasData[key];
    if(!arr||!Array.isArray(arr))return;
    const first=arr[0];
    if(first?.clear){clearCanvasLocal();return;}
    if(first?.fill){floodFill(first.x,first.y,first.c);return;}
    if(first?.shape){renderShape(first,first.shape,first.c,first.s);return;}
    arr.forEach(s=>drawLine(s.x1,s.y1,s.x2,s.y2,s.c,s.s));
  });
}

function listenCanvas(){
  const ref=db.ref(`drawcanvas/${currentRoom.code}`);
  canvasData={};canvasKeyOrder=[];undoKeys=[];

  const cbAdd=ref.on('child_added',snap=>{
    const key=snap.key,arr=snap.val();
    if(!arr||!Array.isArray(arr))return;
    canvasData[key]=arr;
    canvasKeyOrder.push(key);
    // 실시간 렌더링 (이미 그려진 건 다시 안 그림)
    const first=arr[0];
    if(first?.clear){clearCanvasLocal();return;}
    if(first?.fill){floodFill(first.x,first.y,first.c);return;}
    if(first?.shape){renderShape(first,first.shape,first.c,first.s);return;}
    arr.forEach(s=>drawLine(s.x1,s.y1,s.x2,s.y2,s.c,s.s));
  });

  const cbRemove=ref.on('child_removed',snap=>{
    const key=snap.key;
    delete canvasData[key];
    canvasKeyOrder=canvasKeyOrder.filter(k=>k!==key);
    redrawAll();
  });

  listeners.push(()=>{ref.off('child_added',cbAdd);ref.off('child_removed',cbRemove);});
}

/* ===== 채팅 ===== */
function listenChat(){const ref=db.ref(`drawchat/${currentRoom.code}`);const cb=ref.orderByChild('ts').limitToLast(100).on('child_added',snap=>{const d=snap.val();if(!d)return;appendChat(d);if(d.correct)showCorrectOverlay(d.nick,d.text);});listeners.push(()=>ref.off('child_added',cb));}

function sendChat(){
  const input=document.getElementById('chat-input'),text=input.value.trim();
  if(!text||!currentRoom)return;input.value='';
  // 정답 체크
  if(gameState&&gameState.status==='drawing'&&!gameState.solved&&gameState.drawer!==myNick){
    if(text.replace(/\s/g,'').toLowerCase()===gameState.word.replace(/\s/g,'').toLowerCase()){
      // 정답!
      db.ref(`drawchat/${currentRoom.code}`).push().set({nick:myNick,text:gameState.word,ts:Date.now(),correct:true});
      // 점수: 정답자 +1, 출제자 +1
      addScore(myNick,1);
      addScore(gameState.drawer,1);
      // 다음 출제자 = 정답자, 라운드 종료
      db.ref(`drawrooms/${currentRoom.code}/game`).update({solved:true,status:'reveal',nextDrawer:myNick});
      return;
    }
  }
  db.ref(`drawchat/${currentRoom.code}`).push().set({nick:myNick,text,ts:Date.now()});
}

function addSystemChat(msg){if(!currentRoom)return;db.ref(`drawchat/${currentRoom.code}`).push().set({system:true,text:msg,ts:Date.now()});}

function sendQuickChat(){
  const input=document.getElementById('quick-input'),text=input.value.trim();
  if(!text||!currentRoom)return;input.value='';
  if(gameState&&gameState.status==='drawing'&&!gameState.solved&&gameState.drawer!==myNick){
    if(text.replace(/\s/g,'').toLowerCase()===gameState.word.replace(/\s/g,'').toLowerCase()){
      db.ref(`drawchat/${currentRoom.code}`).push().set({nick:myNick,text:gameState.word,ts:Date.now(),correct:true});
      addScore(myNick,1);addScore(gameState.drawer,1);
      db.ref(`drawrooms/${currentRoom.code}/game`).update({solved:true,status:'reveal',nextDrawer:myNick});
      return;
    }
  }
  db.ref(`drawchat/${currentRoom.code}`).push().set({nick:myNick,text,ts:Date.now()});
}

function appendChat(d){
  const container=document.getElementById('chat-messages'),div=document.createElement('div');
  if(d.system){div.className='chat-msg system';div.textContent=d.text;}
  else if(d.correct){div.className='chat-msg correct';div.textContent=`${d.nick} 님이 정답! (+1점)`;}
  else{div.className='chat-msg user';let displayText=d.text;
    if(gameState&&gameState.status==='drawing'&&gameState.word){if(displayText.toLowerCase().includes(gameState.word.toLowerCase()))displayText=displayText.replace(new RegExp(gameState.word,'gi'),'***');}
    div.innerHTML=`<span class="nick">${esc(d.nick)}</span>${esc(displayText)}`;}
  container.appendChild(div);container.scrollTop=container.scrollHeight;
  // 모바일: 채팅 탭이 아닐 때 뱃지 카운트
  if(mobileTab!=='chat'&&window.innerWidth<=768){
    unreadChat++;
    const badge=document.getElementById('chat-badge');
    badge.textContent=unreadChat>99?'99+':unreadChat;
    badge.style.display='inline-block';
  }
}

function showCorrectOverlay(nick,word){
  const o=document.getElementById('correct-overlay');
  document.getElementById('correct-who').textContent=`${nick} 정답!`;
  document.getElementById('correct-word').textContent=word;
  o.classList.add('show');setTimeout(()=>o.classList.remove('show'),2500);
  // 모바일: 정답 나오면 그림판으로 전환
  if(window.innerWidth<=768&&mobileTab==='chat') switchMobileTab('canvas');
}

/* ===== 모바일 탭 전환 ===== */
let mobileTab='canvas',unreadChat=0;

function switchMobileTab(tab){
  mobileTab=tab;
  const layout=document.getElementById('game-layout');
  document.getElementById('tab-canvas').classList.toggle('active',tab==='canvas');
  document.getElementById('tab-chat').classList.toggle('active',tab==='chat');
  if(tab==='chat'){
    layout.classList.add('show-chat');
    unreadChat=0;
    document.getElementById('chat-badge').style.display='none';
    const msgs=document.getElementById('chat-messages');
    msgs.scrollTop=msgs.scrollHeight;
  }else{
    layout.classList.remove('show-chat');
  }
}

// 모바일: 입력 포커스 시 페이지 스크롤 방지
try{
  if('visualViewport' in window&&window.visualViewport){
    window.visualViewport.addEventListener('resize',()=>{
      if(window.innerWidth<=768){
        const sg=document.getElementById('screen-game');
        if(sg)sg.scrollTop=0;
        window.scrollTo(0,0);
      }
    });
  }
  ['chat-input','quick-input'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    el.addEventListener('focus',()=>{
      if(window.innerWidth>768)return;
      setTimeout(()=>{
        window.scrollTo(0,0);
        const sg=document.getElementById('screen-game');
        if(sg)sg.scrollTop=0;
      },300);
    });
  });
}catch(e){}
</script>
</body>
</html>
